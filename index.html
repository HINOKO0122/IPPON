<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>IPPON Online - Entry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .shutter { transition: width 0.3s ease-out; background: #1a1a1a; }
        #ippon-logo { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; font-size: 8rem; color: #ffd700; text-shadow: 0 0 30px #f00; font-weight: 900; pointer-events: none; }
        #entry-screen { backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-yellow-500 min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden font-bold">

    <div id="entry-screen" class="fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm text-center shadow-2xl">
            <h2 class="text-2xl mb-6">ROOM ENTRY</h2>
            <input id="user-name" type="text" placeholder="あなたの名前" class="w-full p-3 mb-4 border-2 border-gray-200 rounded-lg outline-none focus:border-yellow-500">
            <input id="room-pass" type="password" placeholder="パスワード(半角英数字)" class="w-full p-3 mb-6 border-2 border-gray-200 rounded-lg outline-none focus:border-yellow-500">
            <button onclick="checkEntry()" class="w-full bg-black text-white p-4 rounded-xl hover:bg-gray-800 transition">入室する</button>
            <p id="entry-error" class="text-red-500 mt-4 text-sm hidden">パスワードが違います</p>
        </div>
    </div>

    <div id="main-content" class="hidden flex flex-col items-center w-full">
        <div id="left-shutter" class="shutter fixed left-0 top-0 h-full w-0 z-50 border-r border-yellow-600"></div>
        <div id="right-shutter" class="shutter fixed right-0 top-0 h-full w-0 z-50 border-l border-yellow-600"></div>
        <div id="ippon-logo">IPPON!</div>

        <div class="z-10 w-full max-w-2xl bg-black p-8 rounded-3xl shadow-2xl text-center border-4 border-yellow-600">
            <div id="odai-display" class="text-white text-3xl mb-8 min-h-[3rem]">お題を待機中...</div>
            
            <div class="flex gap-2 mb-8">
                <input id="odai-input" type="text" placeholder="次のお題を提案..." class="flex-1 p-3 rounded-lg border-none text-black">
                <button onclick="changeOdai()" class="bg-yellow-600 px-6 py-3 rounded-lg hover:bg-yellow-500">お題変更</button>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button id="ans-mode-btn" onclick="toggleAnswerMode()" class="bg-red-700 text-white p-4 rounded-xl">解答者になる</button>
                <div id="judge-btn-area" class="opacity-30 pointer-events-none">
                    <button onmousedown="vote(true)" onmouseup="vote(false)" class="w-full bg-white text-black p-4 rounded-xl shadow-lg active:scale-95">面白い！</button>
                </div>
            </div>
        </div>

        <div id="status-bar" class="mt-8 text-black bg-white/30 px-6 py-2 rounded-full">
            PLAYER: <span id="display-name">---</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIRelgtipgWC_ARJWCWjcEd1ZFgFIMduc",
            authDomain: "ippon-72b42.firebaseapp.com",
            projectId: "ippon-72b42",
            storageBucket: "ippon-72b42.firebasestorage.app",
            messagingSenderId: "383387859836",
            appId: "1:383387859836:web:970115014f480b2c1442f9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const roomRef = doc(db, "rooms", "room001");

        // --- 設定 ---
        const ROOM_PASSWORD = "ippon"; // ★ここでパスワードを自由に変えてください
        let myName = "";
        let isAnswerMode = false;

        // --- 入室チェック ---
        window.checkEntry = () => {
            const pass = document.getElementById('room-pass').value;
            const name = document.getElementById('user-name').value;
            
            if (pass === ROOM_PASSWORD && name.trim() !== "") {
                myName = name;
                document.getElementById('display-name').innerText = myName;
                document.getElementById('entry-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } else {
                document.getElementById('entry-error').classList.remove('hidden');
            }
        };

        // --- リアルタイム同期 ---
        onSnapshot(roomRef, (snapshot) => {
            const data = snapshot.data();
            if (!data) return;

            document.getElementById('odai-display').innerText = data.odai;
            
            // 75%ロジック (簡易的に必要票数を3票に設定中)
            const required = 3; 
            const progress = (data.votes / required) * 100;
            
            document.getElementById('left-shutter').style.width = `${Math.min(progress/2, 50)}%`;
            document.getElementById('right-shutter').style.width = `${Math.min(progress/2, 50)}%`;

            if (progress >= 100) { showIpponEffect(); }
        });

        // --- 各種アクション ---
        window.changeOdai = async () => {
            const val = document.getElementById('odai-input').value;
            if(val) {
                await updateDoc(roomRef, { odai: val, votes: 0 });
                document.getElementById('odai-input').value = "";
            }
        };

        window.toggleAnswerMode = () => {
            isAnswerMode = !isAnswerMode;
            const btn = document.getElementById('ans-mode-btn');
            const judge = document.getElementById('judge-btn-area');
            
            if (isAnswerMode) {
                btn.innerText = "解答中...";
                btn.classList.replace('bg-red-700', 'bg-blue-600');
                judge.classList.add('opacity-30', 'pointer-events-none');
            } else {
                btn.innerText = "解答者になる";
                btn.classList.replace('bg-blue-600', 'bg-red-700');
                judge.classList.remove('opacity-30', 'pointer-events-none');
            }
        };

        window.vote = async (isPressing) => {
            if (isAnswerMode) return;
            await updateDoc(roomRef, { votes: increment(isPressing ? 1 : -1) });
        };

        function showIpponEffect() {
            const logo = document.getElementById('ippon-logo');
            logo.style.display = 'block';
            setTimeout(() => { logo.style.display = 'none'; }, 2500);
        }
    </script>
</body>
</html>
